<!DOCTYPE html>
<html>
<head>
    <meta charset=utf-8 />
    <title>A simple map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    
    <script src='https://api.mapbox.com/mapbox.js/v2.2.4/mapbox.js'></script>
    <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js'></script>
    <script src='https://code.jquery.com/jquery-1.12.0.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-statistics/1.0.0/simple_statistics.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    
    <link href='https://api.mapbox.com/mapbox.js/v2.2.4/mapbox.css' rel='stylesheet' />
    <link href='https://fonts.googleapis.com/css?family=Handlee' rel='stylesheet' type='text/css'>
    
    <style>
        body {
            margin:0;
            padding:0;
            font-family: 'Handlee', cursive;
            color: #488a99;
            font-weight: 200;
        }
        #map {
            position:absolute;
            top:0;
            bottom:0;
            right:0;
            width: 72%;
        }
        #side-panel {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 28%;
            background: #34282c;
            border-right: 0.8px solid #488a99;
            border-left: 0.8px solid #488a99;
            border-bottom: 0.8px solid #488a99;
            overflow-y: scroll;
        }
        h1 {
            padding: 20px 22px 10px 15px;
            margin: 0;
            background: #488a99;
            color: #dbae58;
            font-weight: 500;
            font-size: 1.8em;
            text-align: right;
        }
        h2 {
            margin: 0;
            padding: 8px 25px 8px 15px;
            background: #488a99;
            color: #b4b4b4;
            font-weight: 500;
            font-size: 1.2em;
            text-align: right;
        }
        h3 {
            color: #dbae58;
            font-weight: 500;
            font-size: 1.2em;
            text-align: center;
        }
        #side-panel p {
            margin: 12px 0 8px; 
            padding: 0 25px 0 15px;
            color: #b4b4b4;
            text-align: right;
            font-size: 1em; 
        }
        #side-panel p:after {
            content: '';
            display: block;
            clear: both;
        }
        #side-panel img {
            float: right;
            margin: 15px 15px 15px 15px;
        }   
        p {
            font-size: 1em;
            color: #488a99;
            font-family: 'Handlee', cursive;
        }
        #subject-button {
            position: absolute;
            top: 100px;
            right: 80px;
            background: rgba(25,25,25,0.8);
            border-radius: 5px;
        }
        #subject {
            position: absolute;
            left: 36%;
            top: 60px;
            color: #488a99;
            font-size: 27px;  
        }
        #subject span {
            font-size: 1.3em;
            font-weight: 500;
            color: #dbae58;
        }
        #legend {
            position: absolute;
            right: 0;
            bottom: 0;
        }
        #info {
            padding: 8px 15px;
            background: rgba(25,25,25,0.6);
            border-radius: 3px;
            position: absolute;
            font-size: 1em;
            max-width: 200px; 
            display: none;
        }
        .info p {
            margin: 3px 0 4px;
            color:#488a99;
        }
        .private {
            color:#dbae58;
        }
        .federal {
            color:#ffffff;
        }
        #info span:last-child {
            font-size: 1.3em;
            font-weight: 500;
        }
    </style>
</head>
<body>
    
    <div id='map'></div>
    
    <div id='side-panel'>
        <h1>Texbook Rates by Subject in Kenya</h1>
        <h2>Number of books per type of School</h2>
    <p>Education in developing countries is often hindered by large class sizes and low teaching quality. Over the past decade many developing countries have expanded primary school access, energized by initiatives such as the United Nations Millennium Development Goals, which call for achieving universal primary education by 2015. But increased quantity has not always been matched with improved quality.</p>
    <p><img src="images/legend.png" alt="legend"</p>
    <p>In Kenya, 50 percent of families live below the poverty line, and high teacher absenteeism is reported in schools.2 Nevertheless the overwhelming majority of children start primary school. But some schools appear to promote only strong students to grade 8 in order to maintain high average scores on secondary school entrance exams, and those not promoted often drop out. Many students also drop out in earlier grades â€“ 35 percent of the surveyed students in grade 3 dropped within the next three years. </p>
    <h2>About this map</h2>
    <p>Sharing textbooks is common in Kenya, and two or three students typically share a workspace. Hence, a 60 percent textbook per pupil ratio was provided in English and science, and a 50 percent ratio was provided in math, giving nearly all students shared access to a textbook. A pre-test in the form of a district exam was administered to all schools before the textbooks were distributed, and district exam scores were collected at the end of each of the subsequent program years for comparison data. Classroom activities, attendance and dropout rates were also monitored. </p>
    <h2>About the data</h2>
    <p>This study found no evidence that textbook provision increased average test scores, or that it reduced either grade repetition or dropout rates. However, textbooks did benefit students with higher average pretest scores: those in the top 40 percent of the class saw test score increases between 0.14 and 0.22 standard deviations after one year.</p>
    </div>
    
    <div id="subject-button">
        <input type="radio" name="textbook" value="English" checked>English<br>
        <input type="radio" name="textbook" value="Kiswahili" >Kiswahili<br>
        <input type="radio" name="textbook" value="Math" >Math<br>
        <input type="radio" name="textbook" value="Science">Science<br>
        <input type="radio" name="textbook" value="Social Studies">Social Studies<br>
    </div>
    
    <div id="subject">Subject: <span>English</span></div>
    
    <div id="legend">
        <h3>Number of Textbooks by County</h3>
        <svg class="legend" width="300" height="300"></svg>
    </div>
    
    <div id="info">
        <p>County: <span></span></p>
        <p class='private'>Private school: <span></span></span></span></p>
        <p class='federal'>Public school: <span></span></span></span></p>
    </div>

    <script>
        
        L.mapbox.accessToken = 'pk.eyJ1Ijoicmdkb25vaHVlIiwiYSI6Im5Ua3F4UzgifQ.PClcVzU5OUj17kuxqsY_Dg';

        var map = L.mapbox.map('map', 'mapbox.dark', {
            center: [-.23, 37.8],
            zoom: 7,
            minZoom: 6,
            maxZoom: 9,
            maxBounds: L.latLngBounds([-6.22, 27.72],[5.76, 47.83])
        });
        
        omnivore.csv('books_subject.csv')
            .on('ready', function(e) {
                drawMap(e.target.toGeoJSON());
            }).on('error', function(e) {
                console.log(e)
        });
        
        function drawMap(booksData) {
            var private = L.geoJson(booksData, {
                pointToLayer: function(feature, latlng) {
                    return L.circleMarker(latlng, {
                        color: '#dbae58',
                        opacity: 1,
                        weight: 1,
                        fillOpacity: 0.1
                    });
                }
                
            }).addTo(map);
            
            var federal = L.geoJson(booksData, {
                  pointToLayer: function(feature, latlng) {
                    return L.circleMarker(latlng, {
                        color: '#ffffff',
                        opacity: 0.7,
                        weight: 0.7,
                        fillOpacity: 0.1
                    });
                }
                
            }).addTo(map);
            
            updateSymbols(private, federal, "English");
            subjectButton(private, federal);
        
        }
        
        function updateSymbols(private, federal, currentSubject) {
           
            var allRadii = [],
                radius;
            
            private.eachLayer(function(layer) {
                radius = calcRadius(layer.feature.properties["P"+currentSubject]);
                layer.setRadius(radius)
                allRadii.push(radius);
                
            });
           
             federal.eachLayer(function(layer) {
                radius = calcRadius(layer.feature.properties["F"+currentSubject]);
                layer.setRadius(radius)
                allRadii.push(radius);
            });
            
            drawLegend(allRadii);
            infoWindow(private, federal, currentSubject);
        }
        
        function calcRadius(val) {
            var radius = Math.sqrt(val/Math.PI);
            return radius * .2;
        }
        
        
        function subjectButton (private, federal) {
            $('#subject-button input')
                .on('change', function(){
                var currentSubject = $(this).val();
                    updateSymbols(private, federal, $(this).val());
                $('#subject span').html(currentSubject)
                });
        }
        
        function drawLegend(allRadii) {
            var legend = $('.legend')
            var circles = {
                max: ss.max(allRadii),
                median: ss.median(allRadii),
                min: ss.min(allRadii)
            }
            
            var svgCircle = '';
            var reverseCalc = function(radius) {   
                return Math.round(Math.pow(radius/.2, 2) * Math.PI)
            }
            
            for(var circle in circles) {
                var radiusValue = circles[circle];
                var actualValue = reverseCalc(radiusValue);
              
                svgCircle += '<circle cx="140" cy="' + (radiusValue - 240) * -1 + '" r="' + radiusValue + 
                    '"stroke="#488a99" stroke-width="1" fill="black" />';
                svgCircle += '<text x="'+ 120 +'" y ="' + (radiusValue - 205) * -1 +'" fill="#488a99">'+ actualValue +                                  '</text>'    
            }
            
            legend.html(svgCircle);
        }
        
        function infoWindow(private, federal, currentSubject) {
            var info = $('#info');
            federal.on('mouseover', function(e) {
                info.show();
                
                var props = e.layer.feature.properties;
                
                $('#info p:first-child span').text(props.COUNTY);
                $(".private span:first-child").text('(subject' + currentSubject +')');
                $(".federal span:first-child").text('(subject' + currentSubject +')');
                
                $(".private span:last-child").text(props['P'+String(currentSubject)].toLocaleString()+' textbooks');
                $(".federal span:last-child").text(props['F'+String(currentSubject)].toLocaleString()+' textbooks');
                
                e.layer.setStyle({ fillOpacity: .6 });
            })
            
            federal.on('mouseout', function(e) {
                info.hide();
                e.layer.setStyle({ fillOpacity: .1});
            });
            
            $(document).mousemove(function (e) {
                info.css({"left": e.pageX + 6, "top": e.pageY - info.height() - 15});
                    if(info.offset().top < 4) {
                        info.css({"top": e.pageY + 15});
            } 
                    if(info.offset().left + info.width() >= $(document).width() - 40) {
                        info.css({"left": e.pageX - info.width() - 30});
            }
                
            });
        }
    
    </script>
</body>
</html>
